#include <Arduino.h>
#include <esp_now.h>
#include <WiFi.h>
#include <esp_wifi.h>
#include "AISData.h"
#include "config.h"

WiFiClient tcpClient;
unsigned long lastReconnectAttempt = 0;
bool wifiConnected = false;
bool signalkConnected = false;

const char* getNavStatusString(uint8_t status) {
  switch(status) {
    case NAV_STATUS_UNDERWAY_ENGINE: return "Underway (Engine)";
    case NAV_STATUS_ANCHORED: return "Anchored";
    case NAV_STATUS_NOT_UNDER_COMMAND: return "Not Under Command";
    case NAV_STATUS_RESTRICTED_MANOEUVRABILITY: return "Restricted Manoeuvrability";
    case NAV_STATUS_CONSTRAINED_BY_DRAUGHT: return "Constrained by Draught";
    case NAV_STATUS_MOORED: return "Moored";
    case NAV_STATUS_AGROUND: return "Aground";
    case NAV_STATUS_FISHING: return "Fishing";
    case NAV_STATUS_UNDERWAY_SAILING: return "Underway (Sailing)";
    default: return "Unknown";
  }
}

void printConnectionStatus() {
  Serial.println("\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONNECTION STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
  
  // WiFi Status
  Serial.print("â”‚ WiFi:    ");
  if (WiFi.status() == WL_CONNECTED) {
    Serial.print("âœ“ CONNECTED (");
    Serial.print(WiFi.localIP());
    Serial.println(")     ");
  } else {
    Serial.println("âœ— DISCONNECTED                  ");
  }
  
  Serial.print("â”‚ SignalK: ");
  if (tcpClient.connected()) {
    Serial.print("âœ“ CONNECTED (");
    Serial.print(SIGNALK_SERVER);
    Serial.print(":");
    Serial.print(SIGNALK_PORT);
    Serial.println(")");
  } else {
    Serial.println("âœ— DISCONNECTED                  ");
  }
  
  // ESP-NOW Status
  Serial.println("â”‚ ESP-NOW: âœ“ ACTIVE (listening)          ");
  
  Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
}

void connectToSignalK() {
  if (tcpClient.connected()) {
    if (!signalkConnected) {
      signalkConnected = true;
      Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
      Serial.println("â”‚ âœ“ SignalK TCP CONNECTED                â”‚");
      Serial.print  ("â”‚   ");
      Serial.print(SIGNALK_SERVER);
      Serial.print(":");
      Serial.print(SIGNALK_PORT);
      Serial.println("                     â”‚");
      Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
    }
    return;
  }
  
  unsigned long currentTime = millis();
  if (currentTime - lastReconnectAttempt < SIGNALK_RECONNECT_INTERVAL_MS) {
    return;
  }
  
  lastReconnectAttempt = currentTime;
  signalkConnected = false;
  
  Serial.print("â†’ Attempting SignalK connection... ");
  
  if (tcpClient.connect(SIGNALK_SERVER, SIGNALK_PORT)) {
    signalkConnected = true;
    Serial.println("SUCCESS!");
    Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    Serial.println("â”‚ âœ“ SignalK TCP CONNECTED                â”‚");
    Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
  } else {
    Serial.println("FAILED!");
    Serial.println("  âš  Cannot reach SignalK server");
    Serial.println("  âš  Will retry in 5 seconds...\n");
  }
}

// Calculate NMEA checksum
uint8_t calculateChecksum(const char* sentence) {
  uint8_t checksum = 0;
  // Start after $ or !, end before *
  for (int i = 1; sentence[i] != '*' && sentence[i] != '\0'; i++) {
    checksum ^= sentence[i];
  }
  return checksum;
}

void latToNMEA(float lat, char* result, char* ns) {
  *ns = (lat >= 0) ? 'N' : 'S';
  float absLat = fabs(lat);
  int degrees = (int)absLat;
  float minutes = (absLat - degrees) * 60.0;
  sprintf(result, "%02d%07.4f", degrees, minutes);
}

void lonToNMEA(float lon, char* result, char* ew) {
  *ew = (lon >= 0) ? 'E' : 'W';
  float absLon = fabs(lon);
  int degrees = (int)absLon;
  float minutes = (absLon - degrees) * 60.0;
  sprintf(result, "%03d%07.4f", degrees, minutes);
}

void sendToSignalK(const AISData &data) {
  if (!tcpClient.connected()) {
    if (signalkConnected) {
      Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
      Serial.println("â”‚ âœ— SignalK TCP DISCONNECTED             â”‚");
      Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
      signalkConnected = false;
    }
    connectToSignalK();
    if (!tcpClient.connected()) {
      Serial.println("  âš  Skipping SignalK send - not connected\n");
      return;
    }
  }
  
  char latStr[16], lonStr[16];
  char ns, ew;
  latToNMEA(data.latitude, latStr, &ns);
  lonToNMEA(data.longitude, lonStr, &ew);
  
  char sentence[256];
  snprintf(sentence, sizeof(sentence),
    "$GPGGA,120000,%s,%c,%s,%c,1,08,0.9,%.1f,M,0.0,M,,*",
    latStr, ns, lonStr, ew, (float)data.sog
  );
  
  uint8_t checksum = calculateChecksum(sentence);
  char fullSentence[300];
  snprintf(fullSentence, sizeof(fullSentence), "%s%02X\r\n", sentence, checksum);
  
  char vesselInfo[256];
  snprintf(vesselInfo, sizeof(vesselInfo),
    "$PNEPT,MMSI=%lu,NAME=%s,SOG=%.1f,COG=%.1f,HDG=%u,STATUS=%u*",
    data.mmsi, data.vesselName, data.sog, data.cog, data.heading, data.navStatus
  );
  
  checksum = calculateChecksum(vesselInfo);
  char fullVesselInfo[300];
  snprintf(fullVesselInfo, sizeof(fullVesselInfo), "%s%02X\r\n", vesselInfo, checksum);
  
  size_t written = tcpClient.print(fullSentence) + tcpClient.print(fullVesselInfo);
  
  Serial.println("  â”Œâ”€ SignalK Forward (NMEA0183) â”€â”€â”€â”€â”€â”€â”");
  if (written > 0) {
    Serial.print("  â”‚ âœ“ Sent ");
    Serial.print(written);
    Serial.println(" bytes (NMEA)          â”‚");
    Serial.println("  â”‚ Format: NMEA0183/AIS               â”‚");
  } else {
    Serial.println("  â”‚ âœ— FAILED                           â”‚");
    tcpClient.stop();
    signalkConnected = false;
  }
  Serial.println("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
}

void displayAISData(const AISData &data) {
  Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘      ğŸš¢ AIS VESSEL DATA RECEIVED ğŸš¢          â•‘");
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  Serial.print("â•‘ Vessel Name:  ");
  Serial.println(data.vesselName);
  Serial.print("â•‘ MMSI:         ");
  Serial.println(data.mmsi);
  Serial.print("â•‘ Position:     ");
  Serial.print(data.latitude, 6);
  Serial.print("Â° N, ");
  Serial.print(data.longitude, 6);
  Serial.println("Â° E");
  Serial.print("â•‘ Speed (SOG):  ");
  Serial.print(data.sog, 1);
  Serial.println(" knots");
  Serial.print("â•‘ Course (COG): ");
  Serial.print(data.cog, 1);
  Serial.println("Â°");
  Serial.print("â•‘ Heading:      ");
  if (data.heading == 511) {
    Serial.println("Not Available");
  } else {
    Serial.print(data.heading);
    Serial.println("Â°");
  }
  Serial.print("â•‘ Nav Status:   ");
  Serial.println(getNavStatusString(data.navStatus));
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

void onDataReceive(const uint8_t *mac_addr, const uint8_t *data, int data_len) {
  if (data_len != sizeof(AISData)) {
    Serial.println("âš  ERROR: Received invalid data size");
    return;
  }
  
  AISData receivedData;
  memcpy(&receivedData, data, sizeof(AISData));
  
  Serial.println("\n===============================================");
  Serial.println("    ğŸ“¡ ESP-NOW TRANSMISSION RECEIVED ğŸ“¡");
  Serial.println("===============================================\n");
  
  displayAISData(receivedData);
  sendToSignalK(receivedData);
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n");
  Serial.println("â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ");
  Serial.println("â–ˆ                                             â–ˆ");
  Serial.println("â–ˆ   ESP32 AIS RECEIVER - SIGNALK GATEWAY     â–ˆ");
  Serial.println("â–ˆ                                             â–ˆ");
  Serial.println("â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ");
  Serial.println();
  
  Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WIFI SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
  WiFi.mode(WIFI_AP_STA);
  
  Serial.print("â”‚ SSID: ");
  Serial.println(WIFI_SSID);
  Serial.println("â”‚ Connecting...");
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  
  int wifiTimeout = 0;
  Serial.print("â”‚ ");
  while (WiFi.status() != WL_CONNECTED && wifiTimeout < WIFI_TIMEOUT_SEC) {
    delay(500);
    Serial.print(".");
    wifiTimeout++;
    if (wifiTimeout % 10 == 0) Serial.print("\nâ”‚ ");
  }
  Serial.println();
  
  if (WiFi.status() == WL_CONNECTED) {
    wifiConnected = true;
    Serial.println("â”‚ âœ“ WiFi CONNECTION SUCCESSFUL!");
    Serial.print("â”‚ IP: ");
    Serial.println(WiFi.localIP());
    Serial.print("â”‚ Signal: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
    Serial.print("â”‚ WiFi Channel: ");
    Serial.println(WiFi.channel());
  } else {
    wifiConnected = false;
    Serial.println("â”‚ âœ— WiFi CONNECTION FAILED!");
    Serial.println("â”‚ âš  Will continue trying...");
  }
  Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
  
  Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ ESP-NOW SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
  Serial.print("â”‚ MAC: ");
  Serial.println(WiFi.macAddress());
  
  if (esp_now_init() != ESP_OK) {
    Serial.println("â”‚ âœ— ERROR: Initialization failed!");
    Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
    return;
  }
  
  esp_wifi_set_channel(ESPNOW_CHANNEL, WIFI_SECOND_CHAN_NONE);
  Serial.print("â”‚ âœ“ ESP-NOW channel set to ");
  Serial.println(ESPNOW_CHANNEL);
  
  esp_now_register_recv_cb(onDataReceive);
  Serial.println("â”‚ âœ“ ESP-NOW initialized");
  Serial.println("â”‚ âœ“ Listening for AIS data...");
  Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
  
  Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ SIGNALK CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
  Serial.print("â”‚ Server: ");
  Serial.print(SIGNALK_SERVER);
  Serial.print(":");
  Serial.println(SIGNALK_PORT);
  Serial.println("â”‚ Connecting...");
  Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
  
  connectToSignalK();
  printConnectionStatus();
  
  Serial.println("ğŸŸ¢ SYSTEM READY - Waiting for AIS data...\n");
  Serial.println("===============================================\n");
}

void loop() {
  static unsigned long lastStatusPrint = 0;
  
  connectToSignalK();
  
  static unsigned long lastWifiCheck = 0;
  if (WiFi.status() != WL_CONNECTED) {
    if (wifiConnected) {
      Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
      Serial.println("â”‚ âœ— WiFi connection LOST!             â”‚");
      Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
      wifiConnected = false;
    }
    
    if (millis() - lastWifiCheck > WIFI_RECONNECT_INTERVAL_MS) {
      lastWifiCheck = millis();
      Serial.println("â†’ Attempting WiFi reconnection...");
      WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
    }
  } else {
    if (!wifiConnected) {
      Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
      Serial.println("â”‚ âœ“ WiFi RECONNECTED!                 â”‚");
      Serial.print  ("â”‚ IP: ");
      Serial.println(WiFi.localIP());
      Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
      wifiConnected = true;
    }
  }
  
  if (millis() - lastStatusPrint > STATUS_PRINT_INTERVAL_MS) {
    lastStatusPrint = millis();
    printConnectionStatus();
  }
  
  delay(100);
}
